<!DOCTYPE html>
<!--
Copyright (C) 2019 Aditya Nathwani <adityanathwani@gmail.com>

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program.  If not, see <http://www.gnu.org/licenses/>.
-->
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <script>
            if (!localStorage.loggedIn) {
                window.location.href = 'login.html' + window.location.hash;
            }
        </script>
        <title>Home - Friends' Wall Social Network</title>
        <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0">
        <meta name="theme-color" content="#000000" />
        <link rel="stylesheet" type="text/css" href="css/w3.css" />
        <link rel="stylesheet" type="text/css" href="css/custom.css" />
        <script type="text/javascript" src="js/jquery.min.js"></script>
    </head>
    <body style="background-image: url('img/bg.jpg');background-attachment: fixed;background-size: cover;">

        <div class="w3-sidebar w3-bar-block w3-animate-left w3-collapse w3-border-right background-light" style="display:none;" id="leftMenu">
            <div class="w3-center w3-border-top w3-padding"><img src="api/media/dp/default.jpg" height="125" width="125" alt="Profile Picture" class="dp w3-circle w3-border" /></div>
            <a class="w3-bar-item w3-button w3-border-bottom w3-center full_name" href="#profile" id="itemprofile">Profile</a>
            <a class="w3-bar-item w3-button" href="#walls" id="itemwalls"><span class="fas fa-newspaper"></span> Walls</a>
            <a class="w3-bar-item w3-button" href="#messages" id="itemmessages"><span class="fas fa-envelope"></span> Messages</a>
            <a class="w3-bar-item w3-button" href="#groups" id="itemgroups"><span class="fas fa-users"></span> Groups</a>
            <a class="w3-bar-item w3-button" href="#search" id="itemsearch"><span class="fas fa-search"></span> Search</a>
            <a class="w3-bar-item w3-button" href="#logout" id="itemlogout"><span class="fas fa-sign-out-alt"></span> Logout</a>
        </div>

        <div class="w3-sidebar w3-bar-block w3-animate-right w3-collapse w3-border-left" style="display:none;right:0;" id="rightMenu">
            <div class="w3-row w3-border-top" id="notificationButtons">
                <button id="shortcut_requests" onclick="showShortcut('requests');" class="w3-col w3-button s4 w3-hover-text-red" data-ripple="rgba(0, 0, 0, 1)"><span class="fas fa-user-clock"></span><span style="position: absolute;top: 0;display: none;" class="w3-badge w3-small" id="no_requests">0</span></button>
                <button id="shortcut_messages" onclick="showShortcut('messages');" class="w3-col w3-button s4 w3-hover-text-blue" data-ripple="rgba(0, 0, 0, 1)"><span class="fas fa-comment-alt"></span></button>
                <button id="shortcut_notifications" onclick="showShortcut('notifications');" class="w3-col w3-button s4 w3-hover-text-green" data-ripple="rgba(0, 0, 0, 1)"><span class="fas fa-bell"></span></button>
            </div>
            <div id="shortcutc_requests" style="display:none;"><small class="w3-text-grey">Requests</small>
                <div id="shortcut_content_requests">
                    <div id="shortcut_requests_list"></div>
                    <div id="shortcut_requests_prototype" style="display: none;" class="w3-small w3-padding-small w3-border-bottom w3-cell-row">
                        <div class="w3-cell-middle w3-cell"><img class="request_dp w3-circle w3-border" style="height: 50px;width: 50px;" alt="profile picture" src="" /></div>
                        <div class="w3-cell w3-padding-small">
                            <p><a class="request_name link"></a></p>
                            <div class="w3-cell-row">
                                <div class="w3-cell w3-center"><button class="w3-button w3-blue w3-hover-blue w3-tiny w3-block request_accept" data-ripple="rgba(0, 0, 0, 1)"><span class="fas fa-check"></span></button></div>
                                <div class="w3-cell s6 w3-center"><button class="w3-button w3-red w3-hover-red w3-tiny w3-block request_reject" data-ripple="rgba(0, 0, 0, 1)"><span class="fas fa-times"></span></button></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div id="shortcutc_messages" style="display:none;"><small class="w3-text-grey">Messages</small>
                <div id="shortcut_content_messages"></div>
            </div>
            <div id="shortcutc_notifications" style="display:none;"><small class="w3-text-grey">Notifications</small>
                <div id="shortcut_content_notifications"></div>
            </div>
        </div>

        <div class="w3-main w3-white w3-border-bottom" style="opacity: 0.7;margin-left:200px;margin-right:200px;" id="main">
            <div class="w3-cell-row">
                <div class="w3-cell w3-hide-large" style="text-align: left">
                    <button onclick="toggleMenu('left');" class="w3-button w3-large w3-hover-none" data-ripple="rgba(0, 0, 0, 1)" style="border-bottom-left-radius: 0;border-bottom-right-radius: 0;" id="leftMenuOpener"><span class="fas fa-bars">&nbsp;</span></button>
                </div>
                <div class="w3-cell w3-cell-middle w3-xlarge" style="text-align: center;text-transform: capitalize;" id="heading">Friends' Wall</div>
                <div class="w3-cell w3-hide-large" style="text-align: right">
                    <button onclick="toggleMenu('right');" class="w3-button w3-large w3-hover-none" data-ripple="rgba(0, 0, 0, 1)" style="border-bottom-left-radius: 0;border-bottom-right-radius: 0;"><span class="fas fa-bell">&nbsp;</span></button>
                </div>
            </div>
        </div>
        <div class="w3-main" style="margin-left:200px;margin-right:200px;min-height: 80vh;" id="content">
            <div id="pageloader" class="w3-center w3-margin-top"><span class="fas fa-spinner fa-spin w3-xlarge"></span><br>Loading</div>
        </div>

        <div class="toast w3-card w3-animate-bottom" style="position: fixed;font-size: 1.2em;display: none;height: 2.5em;line-height: 2.5em;background-color: #323232;color: #d1d1d1;opacity: .9;top: 2%;right: 45%;padding-left: 8px;padding-right: 8px;z-index: 999;"></div>

        <script type="text/javascript" src="js/fontawesome-all.min.js"></script>
        <script type="text/javascript" src="js/custom.js"></script>
        <script>
            var menu = {'left': $('#leftMenu'), 'right': $('#rightMenu')};
            var content = $("#content");
            var heading = $("#heading");
            var loadedPages = {};
            loadedPages["loader"] = true;
            var leftMenuButtons = $('#leftMenu a');
            var userinfo;
            var titlePrefix = " - Friends' Wall Social Network";
            var title = $("title");
            var shortcuts = {
                'requests': $("#shortcut_requests"),
                'messages': $("#shortcut_messages"),
                'notifications': $("#shortcut_notifications")
            };
            var shortcutsc = {
                'requests': $("#shortcutc_requests"),
                'messages': $("#shortcutc_messages"),
                'notifications': $("#shortcutc_notifications")
            };
            var shortcut_requests_prototype = $("#shortcut_requests_prototype");
            var shortcut_requests_list = $("#shortcut_requests_list");
            var no_requests = $("#no_requests");
            
            function showShortcut(shortcutName) {
                shortcuts['requests'].removeClass("w3-red w3-hover-red").addClass("w3-hover-text-red");
                shortcuts['messages'].removeClass("w3-blue w3-hover-blue").addClass("w3-hover-text-blue");
                shortcuts['notifications'].removeClass("w3-green w3-hover-green").addClass("w3-hover-text-green");
                shortcutsc['requests'].hide();
                shortcutsc['messages'].hide();
                shortcutsc['notifications'].hide();
                switch (shortcutName) {
                    case 'requests':
                        shortcutsc['requests'].show();
                        shortcuts['requests'].addClass("w3-red w3-hover-red").removeClass("w3-hover-text-red");
                        break;

                    case 'messages':
                        shortcutsc['messages'].show();
                        shortcuts['messages'].addClass("w3-blue w3-hover-blue").removeClass("w3-hover-text-blue");
                        break;

                    case 'notifications':
                        shortcutsc['notifications'].show();
                        shortcuts['notifications'].addClass("w3-green w3-hover-green").removeClass("w3-hover-text-green");
                        break;

                        break;
                }
            }
            function closeMenus() {
                menu['right'].hide();
                menu['left'].hide();
                content.off("touchstart");
            }
            function toggleMenu(side) {
                if (side === 'left') {
                    menu['right'].hide();
                } else {
                    menu['left'].hide();
                }
                if (menu[side].css("display") === "block") {
                    menu[side].hide();
                    content.off("touchstart");
                } else {
                    menu[side].show();
                    content.on("touchstart", closeMenus);
                }
            }
            $(function () {
                var mainHeight = $('#main').height();
                $('.w3-sidebar').css('margin-top', mainHeight).css('padding-top', mainHeight);
                $("#notificationButtons").css("margin-top", (mainHeight * (-1)));
                $(window).resize(function () {
                    var tMainHeight = $('#main').height();
                    $('.w3-sidebar').css('margin-top', tMainHeight).css('padding-top', tMainHeight);
                    $("#notificationButtons").css("margin-top", (tMainHeight * (-1)));
                });
                if (window.location.hash) {
                    loadPage(window.location.hash.substring(1));
                } else {
                    loadPage('walls');
                }
                window.onhashchange = function() {
                    if(window.location.hash.split("/").length > 1) {
                        loadTmpPage(window.location.hash.substring(1));
                    } else {
                        loadPage(window.location.hash.substring(1));
                    }
                };
                $.post(base_url + "/home.php")
                        .done(function (data) {
                            if (data.success) {
                                userinfo = data.data.user;
                                updateProfile();
                                updateDP();
                                var sse = new EventSource(base_url + '/sse.php', { 'withCredentials': true });
                                sse.addEventListener('requestInfo',function(e){
                                    var tData = JSON.parse(e.data);
                                    shortcut_requests_list.empty();
                                    for (var i=0; i<tData.length; i++) {
                                        var tElm = shortcut_requests_prototype.clone().removeAttr('id').css('display', 'block');
                                        tElm.find('.request_name').attr('href', '#user/'+tData[i].username).text(tData[i].first_name + ' ' + tData[i].last_name);
                                        if(tData[i].dp) {
                                            tElm.find('img').attr('src', base_site_url + '/api/media/' + tData[i].media + '/' + tData[i].dp + '.jpg');
                                        } else {
                                            tElm.find('img').attr('src', base_site_url + '/api/media/dp/default.jpg');
                                        }
                                        tElm.find('.request_accept').attr("id", "acp"+tData[i].id).click(function() {
                                            friendRequest('accept', $(this).attr("id").substring(3));
                                        });
                                        tElm.find('.request_reject').attr("id", "rej"+tData[i].id).click(function() {
                                            friendRequest('reject', $(this).attr("id").substring(3));
                                        });
                                        tElm.appendTo(shortcut_requests_list);
                                    }
                                    no_requests.text(tData.length);
                                    if (tData.length) {
                                        no_requests.show();
                                    } else {
                                        no_requests.hide();
                                    }
                                },false);
                                showShortcut('requests');
                            } else if (data.error) {
                                toast(data.error);
                                if (data.logout) {
                                    loadPage('logout');
                                }
                            } else {
                                toast("Unknown error occured. Please contact administrator.");
                            }
                        })
                        .fail(function (error) {
                            if (error.status === 0) {
                                toast("Unknown error occured. Make sure you have working internet connection.");
                            } else {
                                toast("Unknown error occured. Please contact administrator.");
                            }
                        });
            });
            function loadPage(fullPage) {
                if (window.location.hash.substring(1) !== fullPage && fullPage !== 'loader') {
                    window.location.href = "#" + fullPage;
                    return;
                }
                var page = fullPage.split('/')[0];
                closeMenus();
                leftMenuButtons.removeClass("w3-black w3-hover-black");
                $("#item" + page).addClass("w3-black w3-hover-black");
                $(content).children("div").hide();
                if (page !== 'loader') {
                    $(heading).text(page);
                }
                if (loadedPages[page]) {
                    $("#page" + page).show();
                } else {
                    $(content).children("#pageloader").show();
                    $('<div />').load("pages/" + page + ".html", function (response, status, xhr) {

                        if (status !== "success" && status !== "notmodified") {
                            if (xhr.status === 404) {
                                this.innerHTML = '<div class="w3-center w3-red w3-xlarge w3-margin">Error: 404 requested page not found</div>';
                            } else {
                                this.innerHTML = "Error loading " + page;
                            }
                        }
                        loadedPages[page] = true;
                        $(content).children("#pageloader").hide();
                    }).attr("id", "page" + page).appendTo(content);
                }
            }
            function loadTmpPage(fullPage) {
                var page = fullPage.split('/')[0];
                closeMenus();
                $(content).children("div").hide();
                $(content).children("#pageloader").show();
                $("#page"+page).remove();
                $('<div />').load("pages/" + page + ".html", function (response, status) {
                    if (status !== "success" && status !== "notmodified") {
                        console.log(status);
                        this.innerHTML = "Error loading " + page;
                    }
                    $(content).children("#pageloader").hide();
                }).attr("id", "page" + page).appendTo(content);
            }
            function reloadPage(fullPage) {
                var page = fullPage.split('/')[0];
                loadPage('loader');
                $("#page"+page).remove();
                loadedPages[page] = false;
                loadPage(fullPage);
            }
            function updateDP() {
                if(userinfo['dp']) {
                    $(".dp").attr("src", base_site_url + "/api/media/" + userinfo['media'] + "/" + userinfo['dp'] + ".jpg");
                } else {
                    $(".dp").attr("src", base_site_url + "/api/media/dp/default.jpg");
                }
            }
            function updateProfile() {
                $(".full_name").text(userinfo["first_name"] + " " + userinfo["last_name"]);
            }
            function friendRequest(action, friendID) {
                $.post(base_url + "/friend.php", {'action': action, 'id': friendID})
                        .done(function (data) {
                            if (data.success) {
                            } else if (data.error) {
                                toast(data.error);
                                if (data.logout) {
                                    loadPage('logout');
                                }
                            } else {
                                toast("Unknown error occured. Please contact administrator.");
                            }
                        })
                        .fail(function (error) {
                            if (error.status === 0) {
                                toast("Unknown error occured. Make sure you have working internet connection.");
                            } else {
                                toast("Unknown error occured. Please contact administrator.");
                            }
                        });
            }
        </script>
    </body>
</html>
